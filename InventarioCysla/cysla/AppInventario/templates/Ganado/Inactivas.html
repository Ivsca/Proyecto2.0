{% load static %}
{% include 'inc/Header.html' %}
<title>Vacunos Inactivos</title>

{# CSRF token meta (fallback). We also read csrftoken cookie in JS. #}
<meta name="csrf-token" content="{{ csrf_token }}">

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary mb-0">Vacunos Inactivos</h2>
        <a href="{% url 'Ganado' %}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>Volver a Vacunos Activos
        </a>
    </div>

    {% if vacas_inactivas %}
    <div class="card shadow-sm border-0">
        <div class="card-header bg-light py-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0 text-secondary">Total: {{ vacas_inactivas|length }} vacuno(s)</h5>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="input-group input-group-sm" style="max-width: 300px;">
                        <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="searchInactivos" class="form-control" placeholder="Buscar...">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center" style="width: 100px;">Foto</th>
                            <th class="text-start">Código</th>
                            <th class="text-start">Raza</th>
                            <th class="text-center">Edad</th>
                            <th class="text-center">Estado</th>
                            <th class="text-center" style="width: 180px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vaca in vacas_inactivas %}
                        <tr class="vacuno-row" data-codigo="{{ vaca.codigocria|lower }}" data-raza="{{ vaca.razas|lower }}" data-estado="{{ vaca.estado|lower }}">
                            <td class="text-center">
                                <div class="d-flex justify-content-center">
                                    <div class="position-relative" style="width: 70px; height: 70px;">
                                        {% if vaca.foto %}
                                            <img src="{{ vaca.foto.url }}" class="rounded-circle border" style="width:100%;height:100%;object-fit:cover;">
                                        {% else %}
                                            <img src="{% static 'Image/img/fondo_vaca.jpg' %}" class="rounded-circle border" style="width:100%;height:100%;object-fit:cover;">
                                        {% endif %}
                                        <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle">
                                            <span class="visually-hidden">Inactivo</span>
                                        </span>
                                    </div>
                                </div>
                            </td>
                            <td class="text-start">
                                <div>
                                    <strong class="text-dark">{{ vaca.codigocria }}</strong>
                                </div>
                                <small class="text-muted">ID: {{ vaca.id }}</small>
                            </td>
                            <td class="text-start">
                                <span class="badge bg-light text-dark">{{ vaca.razas }}</span>
                            </td>
                            <td class="text-center">
                                <span class="fw-bold text-primary">{{ vaca.edad }}</span> meses
                            </td>
                            <td class="text-center">
                                <span class="badge bg-warning text-dark">{{ vaca.estado }}</span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-info" onclick="abrirFormularioVer('{{ vaca.codigocria }}')" title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="rehabilitarVacuno({{ vaca.id }})" title="Reactivar vacuno">
                                        <i class="fas fa-undo-alt"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="eliminarVacunoPermanente({{ vaca.id }})" title="Eliminar permanentemente">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="fas fa-cow fa-4x text-muted"></i>
        </div>
        <h4 class="text-muted">No hay vacunos inactivos</h4>
        <p class="text-muted">Todos los vacunos están activos en el sistema.</p>
        <a href="{% url 'Ganado' %}" class="btn btn-primary mt-2">
            <i class="fas fa-list me-2"></i>Ver vacunos activos
        </a>
    </div>
    {% endif %}
</div>

<!-- Modal para confirmar eliminación permanente -->
<div class="modal fade" id="eliminarPermanenteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Eliminar Permanentemente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea eliminar permanentemente este vacuno?</p>
                <p class="text-danger"><strong>Esta acción no se puede deshacer.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmarEliminacionPermanente">Eliminar Permanentemente</button>
            </div>
        </div>
    </div>
</div>

<!-- SweetAlert & JS logic -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
/* =========================
   CSRF helpers
   ========================= */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
function getCSRFToken() {
    const c = getCookie('csrftoken');
    if (c) return c;
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.getAttribute('content') : '';
}

/* =========================
   Search filter
   ========================= */
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInactivos');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchText = this.value.toLowerCase();
            const rows = document.querySelectorAll('.vacuno-row');

            rows.forEach(row => {
                const codigo = (row.getAttribute('data-codigo') || '').toLowerCase();
                const raza = (row.getAttribute('data-raza') || '').toLowerCase();
                const estado = (row.getAttribute('data-estado') || '').toLowerCase();

                const matches = !searchText || codigo.includes(searchText) || raza.includes(searchText) || estado.includes(searchText);
                row.style.display = matches ? '' : 'none';
            });
        });
    }
});

/* =========================
   Rehabilitar (AJAX GET expected)
   Endpoint: /Ganado/api/Rehabilitar/<id>/
   ========================= */
function rehabilitarVacuno(id) {
    Swal.fire({
        title: "¿Rehabilitar vacuno?",
        text: "El vacuno volverá a la tabla de activos.",
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#198754",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "Sí, rehabilitar",
        cancelButtonText: "Cancelar"
    }).then((result) => {
        if (!result.isConfirmed) return;

        Swal.fire({
            title: 'Rehabilitando...',
            text: 'Por favor espere',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        fetch(`/Ganado/api/Rehabilitar/${id}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(async response => {
            const text = await response.text();
            try {
                return JSON.parse(text);
            } catch (err) {
                throw new Error('Respuesta inesperada del servidor: ' + text);
            }
        })
        .then(data => {
            Swal.close();
            if (data.success) {
                Swal.fire({
                    title: '¡Rehabilitado!',
                    text: data.message || 'El vacuno ha sido rehabilitado correctamente.',
                    icon: 'success',
                    confirmButtonColor: '#198754'
                }).then(() => window.location.reload());
            } else {
                Swal.fire('Error', data.message || 'No se pudo rehabilitar el vacuno.', 'error');
            }
        })
        .catch(error => {
            Swal.close();
            Swal.fire('Error', 'Ocurrió un error al rehabilitar el vacuno: ' + error.message, 'error');
        });
    });
}

/* =========================
   Eliminar permanentemente (AJAX POST)
   Endpoint: /Ganado/EliminarPermanente/<id>/
   ========================= */
function eliminarVacunoPermanente(id) {
    const modal = new bootstrap.Modal(document.getElementById('eliminarPermanenteModal'));
    modal.show();

    // Remove previous handlers to avoid multiple binds
    const confirmarBtn = document.getElementById('confirmarEliminacionPermanente');
    const newHandler = function() {
        modal.hide();

        Swal.fire({
            title: 'Eliminando...',
            text: 'Por favor espere',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        fetch(`/Ganado/EliminarPermanente/${id}/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(async response => {
            const text = await response.text();
            try {
                return JSON.parse(text);
            } catch {
                throw new Error('Respuesta inesperada del servidor: ' + text);
            }
        })
        .then(data => {
            Swal.close();
            if (data.success) {
                Swal.fire({
                    title: '¡Eliminado!',
                    text: data.message || 'El vacuno ha sido eliminado permanentemente.',
                    icon: 'success',
                    confirmButtonColor: '#198754'
                }).then(() => window.location.reload());
            } else {
                Swal.fire('Error', data.message || 'No se pudo eliminar el vacuno.', 'error');
            }
        })
        .catch(error => {
            Swal.close();
            Swal.fire('Error', 'Ocurrió un error al eliminar el vacuno: ' + error.message, 'error');
        });
    };

    // Remove all existing click listeners by cloning the node
    const clone = confirmarBtn.cloneNode(true);
    confirmarBtn.parentNode.replaceChild(clone, confirmarBtn);
    clone.addEventListener('click', newHandler);
}

/* =========================
   Abrir formulario/ver detalles (usa tu endpoint existente)
   Mantengo la función que buscaba por código y abría modal con datos.
   ========================= */
window.abrirFormularioVer = function(codigoCria) {
    fetch(`/Ganado/BuscarCodigo/?q=${encodeURIComponent(codigoCria)}`)
        .then(response => {
            if (!response.ok) throw new Error('Error buscando vacuno');
            return response.json();
        })
        .then(data => {
            if (!data.length) {
                Swal.fire('Error', 'No se encontró el vacuno.', 'error');
                return;
            }
            const vacunoId = data[0].id;
            return fetch(`/Ganado/api/obtener/${vacunoId}/`);
        })
        .then(r => {
            if (!r) return;
            if (!r.ok) throw new Error('Error obteniendo detalles del vacuno');
            return r.json();
        })
        .then(vacuno => {
            if (!vacuno) return;
            let enfermedades = [];
            let vacunas = [];
            let crias = [];
            try {
                enfermedades = JSON.parse(vacuno.enfermedades || '[]');
                vacunas = JSON.parse(vacuno.infovacunas || '[]');
                crias = JSON.parse(vacuno.codigoscrias || '[]');
            } catch {}
            // Construcción del HTML (breve) y mostrar con Swal
            let enfermedadesHtml = enfermedades.length
                ? enfermedades.map(e => `<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb;">${e.disease}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;">${e.date}</td></tr>`).join('')
                : `<tr><td colspan="2" style="padding:8px;text-align:center;color:#059669;">No hay enfermedades registradas</td></tr>`;

            let vacunasHtml = vacunas.length
                ? vacunas.map(v => `<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb;">${v.vaccine}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;">${v.amount}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;">${v.type}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;">${v.date}</td></tr>`).join('')
                : `<tr><td colspan="4" style="padding:8px;text-align:center;color:#059669;">No hay vacunas aplicadas</td></tr>`;

            let criasHtml = crias.length
                ? crias.map(c => `<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb;">${c}</td></tr>`).join('')
                : `<tr><td style="padding:8px;text-align:center;color:#059669;">No hay crías registradas</td></tr>`;

            const html = `
                <div style="display:flex;flex-wrap:wrap;gap:24px;min-width:320px;">
                    <div style="flex:1 1 320px;max-width:420px;">
                        ${vacuno.foto ? `<img src="${vacuno.foto}" style="width:100%;height:320px;object-fit:cover;border-radius:12px;margin-bottom:12px;">` : `<div style="width:100%;height:320px;background:#f8f9fa;border-radius:12px;display:flex;align-items:center;justify-content:center;"><i class="fas fa-camera" style="font-size:60px;color:#bbb;"></i></div>`}
                        <div style="font-weight:700;color:#10b981;font-size:18px;text-align:center;">${vacuno.codigocria || 'Sin código'}</div>
                        <div style="text-align:center;margin-top:6px;"><span class="badge bg-warning text-dark">INACTIVO</span></div>
                    </div>
                    <div style="flex:2 1 420px;">
                        <h3 style="color:#10b981;margin-bottom:12px;text-align:center;">Detalles del Vacuno</h3>
                        <div style="display:flex;flex-wrap:wrap;gap:12px;">
                            <div style="flex:1 1 200px;"><b>Madre:</b> ${vacuno.codigomama || 'N/A'}</div>
                            <div style="flex:1 1 200px;"><b>Padre:</b> ${vacuno.codigopapa || 'N/A'}</div>
                            <div style="flex:1 1 200px;"><b>Parcela:</b> ${vacuno.idparcela || 'N/A'}</div>
                            <div style="flex:1 1 200px;"><b>Raza:</b> ${vacuno.razas || 'N/A'}</div>
                            <div style="flex:1 1 200px;"><b>Edad:</b> ${vacuno.edad || 'N/A'} meses</div>
                            <div style="flex:1 1 200px;"><b>Estado:</b> ${vacuno.estado || 'N/A'}</div>
                        </div>

                        <hr>

                        <div style="margin-bottom:12px;">
                            <strong style="color:#ef4444;display:block;margin-bottom:6px;">Enfermedades</strong>
                            <table style="width:100%;border-collapse:collapse;">
                                <thead><tr style="background:#f3f4f6;"><th style="padding:8px;border-bottom:2px solid #ef4444;text-align:left;">Enfermedad</th><th style="padding:8px;border-bottom:2px solid #ef4444;text-align:left;">Fecha</th></tr></thead>
                                <tbody>${enfermedadesHtml}</tbody>
                            </table>
                        </div>

                        <div>
                            <strong style="color:#3b82f6;display:block;margin-bottom:6px;">Vacunas</strong>
                            <table style="width:100%;border-collapse:collapse;">
                                <thead><tr style="background:#f3f4f6;"><th style="padding:8px;border-bottom:2px solid #3b82f6;text-align:left;">Vacuna</th><th style="padding:8px;border-bottom:2px solid #3b82f6;text-align:left;">Dosis</th><th style="padding:8px;border-bottom:2px solid #3b82f6;text-align:left;">Tipo</th><th style="padding:8px;border-bottom:2px solid #3b82f6;text-align:left;">Fecha</th></tr></thead>
                                <tbody>${vacunasHtml}</tbody>
                            </table>
                        </div>

                        <div style="margin-top:12px;">
                            <strong style="color:#10b981;display:block;margin-bottom:6px;">Crías</strong>
                            <table style="width:100%;border-collapse:collapse;">
                                <thead><tr style="background:#f3f4f6;"><th style="padding:8px;border-bottom:2px solid #10b981;text-align:left;">Código</th></tr></thead>
                                <tbody>${criasHtml}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            Swal.fire({
                title: `Detalles de ${vacuno.codigocria || ''} (Inactivo)`,
                html: html,
                width: '90%',
                showCloseButton: true,
                didOpen: () => {}
            });
        })
        .catch(err => {
            Swal.fire('Error', err.message || 'Ocurrió un error al obtener los datos.', 'error');
        });
};
</script>

<!-- no funciona  ya me canse de lavar y trapear-->

{% include 'inc/Footer.html' %}
